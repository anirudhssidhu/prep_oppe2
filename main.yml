name: MLOps Pipeline for Fraud Detection

on:
  push:
    branches: [ main ]

permissions:
  pull-requests: write
  contents: read

jobs:
  build-and-validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start report
        run: |
          echo "# Pipeline Report" > report.md
          echo "" >> report.md

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

      # âœ… Use official gcloud setup (reliable)
      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      # âœ… Decode SA key, validate JSON, authenticate, and set project from secret
      - name: Authenticate to GCP
        env:
          GCP_B64: ${{ secrets.GCP_CREDENTIALS_B64 }}
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          set -euo pipefail

          if [ -z "${GCP_B64}" ]; then
            echo "âŒ Secret GCP_CREDENTIALS_B64 is empty/not set" | tee -a report.md
            exit 1
          fi
          if [ -z "${GCP_PROJECT_ID}" ]; then
            echo "âŒ Secret GCP_PROJECT_ID is empty/not set" | tee -a report.md
            exit 1
          fi

          echo "$GCP_B64" | base64 -d > gcp-key.json
          test -s gcp-key.json || (echo "âŒ gcp-key.json is empty after base64 decode" | tee -a report.md && exit 1)
          python3 -m json.tool gcp-key.json > /dev/null

          echo "GOOGLE_APPLICATION_CREDENTIALS=$(pwd)/gcp-key.json" >> $GITHUB_ENV

          gcloud auth activate-service-account --key-file=gcp-key.json
          gcloud config set project "$GCP_PROJECT_ID"

          echo "âœ… GCP auth ok (project: $GCP_PROJECT_ID)" >> report.md

      # âœ… CI-stable: remove any partial cache state (fixes .dir/md5 FileNotFoundError)
      - name: Clean DVC state
        run: |
          rm -rf .dvc/cache .dvc/tmp

      # âœ… DVC pull (force rebuild)
      - name: DVC pull
        run: |
          set -euo pipefail
          source .venv/bin/activate
          dvc pull -v --force
          echo "âœ… DVC pull completed" >> report.md

      # --- PRE-TRAINING VALIDATION GATES ---
      - name: Check for Data Poisoning
        id: poison_check
        run: |
          set -euo pipefail
          source .venv/bin/activate
          echo "" >> report.md
          echo "## ðŸ›¡ï¸ Data Poisoning Check" >> report.md

          python src/check_poisoning.py --data-path data/transactions.csv | tee poison_out.txt
          cat poison_out.txt >> report.md

          COUNT=$(grep -E "SUSPICIOUS_COUNT=" poison_out.txt | tail -1 | cut -d= -f2 || true)
          COUNT=${COUNT:-0}
          echo "count=$COUNT" >> "$GITHUB_OUTPUT"

      - name: Validate Data Quality
        run: |
          set -euo pipefail
          if [ "${{ steps.poison_check.outputs.count }}" -gt 100 ]; then
            echo "âŒ Error: High number of suspicious labels detected: ${{ steps.poison_check.outputs.count }}" | tee -a report.md
            exit 1
          else
            echo "âœ… Data quality check passed (count=${{ steps.poison_check.outputs.count }})" >> report.md
          fi

      - name: Check for Data Drift
        run: |
          set -euo pipefail
          source .venv/bin/activate
          echo "" >> report.md
          echo "## ðŸŒŠ Data Drift Check" >> report.md
          python src/check_drift.py | tee drift_out.txt
          cat drift_out.txt >> report.md

      # --- CORE MODELING PIPELINE ---
      - name: Run Model Training
        run: |
          set -euo pipefail
          source .venv/bin/activate
          echo "" >> report.md
          echo "## ðŸ‹ï¸ Training" >> report.md
          python src/train.py | tee train_out.txt
          cat train_out.txt >> report.md

      # --- POST-TRAINING RESPONSIBLE AI CHECKS ---
      - name: Generate Model Explanations (SHAP)
        run: |
          set -euo pipefail
          source .venv/bin/activate
          echo "" >> report.md
          echo "## ðŸ§  Model Explainability (SHAP)" >> report.md
          python src/generate_explanations.py | tee shap_out.txt
          cat shap_out.txt >> report.md

      - name: Check for Model Bias (Fairlearn)
        run: |
          set -euo pipefail
          source .venv/bin/activate
          echo "" >> report.md
          echo "## âš–ï¸ Model Fairness Check (Fairlearn)" >> report.md
          python src/check_fairness.py | tee fair_out.txt
          cat fair_out.txt >> report.md

      # âœ… REQUIRED by Task 1: Build + Push Docker image to Artifact Registry
      - name: Configure Docker auth for Artifact Registry
        env:
          GAR_REGION: ${{ secrets.GAR_REGION }}
        run: |
          set -euo pipefail
          if [ -z "${GAR_REGION}" ]; then
            echo "âŒ Secret GAR_REGION is empty/not set" | tee -a report.md
            exit 1
          fi
          gcloud auth configure-docker "${GAR_REGION}-docker.pkg.dev" --quiet
          echo "âœ… Docker configured for GAR" >> report.md

      - name: Build and Push Docker image
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GAR_REGION: ${{ secrets.GAR_REGION }}
          GAR_REPO: ${{ secrets.GAR_REPO }}
          IMAGE_NAME: ${{ secrets.IMAGE_NAME }}
          SHA: ${{ github.sha }}
        run: |
          set -euo pipefail
          if [ -z "${GAR_REPO}" ] || [ -z "${IMAGE_NAME}" ]; then
            echo "âŒ Secret GAR_REPO or IMAGE_NAME is empty/not set" | tee -a report.md
            exit 1
          fi

          IMAGE_URI="${GAR_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/${GAR_REPO}/${IMAGE_NAME}"
          docker build -t "${IMAGE_URI}:${SHA}" -t "${IMAGE_URI}:latest" .
          docker push "${IMAGE_URI}:${SHA}"
          docker push "${IMAGE_URI}:latest"

          echo "" >> report.md
          echo "## âœ… Docker Build & Push" >> report.md
          echo "- Image: \`${IMAGE_URI}:latest\`" >> report.md
          echo "- Commit: \`${SHA}\`" >> report.md

      # --- REPORTING ---
      - name: Upload All Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ml-artifacts
          path: |
            artifacts/
            report.md

      - name: Setup CML
        uses: iterative/setup-cml@v2

      - name: Create CML Report
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -f artifacts/shap_summary.png ]; then
            echo "" >> report.md
            echo "### SHAP Feature Importance" >> report.md
            echo "![SHAP Summary](./artifacts/shap_summary.png)" >> report.md
          fi
          cml comment create report.md
